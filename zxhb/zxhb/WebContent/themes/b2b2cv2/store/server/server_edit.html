<#include '/store/store_header.html' />
<#assign appMessageTag =newTag("appMessageTag")>
<#assign msList=appMessageTag("{'amid':'${id}'}")>
<#assign ms=msList.appMessage>
<style>
    .store_right_main_list {
        position: absolute;
        left: 660px;
        top: 255px;
    }
    .store_right_main_list .store_right_main_list_body li.lowh {
        line-height: 100%;
        overflow: auto;
        width: 100%;
        height: 90%;
        margin-left: 4px;
        border: 0px;
    }
 	.store_right_main_list .store_right_main_list_body li.lowh img {
       max-width:203px;
      }
    .store_right_main_list .store_right_main_list_body li p {
        text-indent: 0em;
        margin-top: 7px;
    }
    .btn_1 {
        float: right;
        width: 60px;
        height: 30px;
        margin-left: 10px;
    }
	 .file{ width: 82px;  height: 32px; background: #333;  margin: 0 auto;position: absolute;  top: 126px;
        left: 0px;  opacity: 0; filter:alpha(opacity=0); -moz-opacity:0; -khtml-opacity:0;
         z-index: 2;}
	.sotre_bonus dl dt{line-height: 20px;}
</style>
	<div class="store_center">
    <#include '../left_menu.html' />
    <div class="sotre_right_content">
        <div class="path">
            <span style="color:#999;">您的位置：</span>
            <span>></span>
            <a href="#">营销管理 </a><span>></span>信息服务<span>></span>修改
        </div>
        <div class="sotre_bonus" style="position: relative;">
            <div class="store_right_main">
                <div class="tabmenu">
                    <ul class="tab pngFix">
                        <li class=" commont_list" style="line-height: 50px">
                            <a class="active" href="${ctx}/store/server/server_list.html?menu=promotion">信息服务</a>&nbsp;&nbsp;用于对APP信息推送，位于APP首页信息栏。
                        </li>
                        <li class="fr">
                            <span class="cp btn_2" id="submit_btn">确认</span>
                            <span class="cp btn_3" id="return_1">取消</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="server_iframe_box" style="display: none; width: 960px; height: 670px;position: absolute;left: 20px;top:40px;z-index: 101;">
                <div class="tr footer">
                    <a href="javascript:(0)" class="btn_cancel ">取消</a>
                    <a href="javascript:(0)" class="btn_confirm mr30 ">确定</a>
                </div>
            </div>
            <form id="add_form" action="#" method="post">
           		<input type="hidden" value="${ms.id}" name="ms.id">
                <input type="hidden" value="${ms.create_time}" name="ms.create_time">
                <input type="hidden" value="${ms.status}" name="ms.status">
                <input type="hidden"  id="detail"  name="ms.detail">
                <input type="hidden"  id="linkGoods_id" value="${ms.linkGoods_id}" name="ms.linkGoods_id">
                <dl>
                    <dt class="required"><span class="red">*</span>标题:</dt>
                    <dd>
                        <input type="text" value="${ms.title!''}" name="ms.title" id="title" maxlength="15" placeholder="标题最大长度为15字符" class="text w100 mr5" isrequired="true" onblur="changeTiitle();"/>
                    </dd>
                </dl>
				<dl>
					<dt class="required">是否添加商品链接:</dt>
					<dd> <span class="ncu_btn6 " id="yes_link">是</span><span class="ncu_btn9" id="no_link">否</span>
					</dd>
				</dl>
				<dl class="display_link ">
					<dt><span class="red">*</span>商品链接:</dt>
					<dd>
						<input type="text" value="${ms.synopsis}"  name="ms.synopsis" id="synopsis" placeholder="请选择商品链接" onclick="open_server_iframe(${ms.linkGoods_id})" class="text w100 mr5" isrequired="true" />
					</dd>
				</dl>
                <dl>
                    <dt class="required"><span class="red">*</span>责任编辑:</dt>
                    <dd>
                        <input type="text" value="${ms.author!''}" maxlength="10" placeholder="编辑人最大长度为10字符" name="ms.author" id="author" class="text w100 mr5" isrequired="true"/>
                    </dd>
                </dl>
				<dl>
					<dt class="required"><span class="red">*</span>图片内容:</dt>
					<dt class="apply_id_img pr w404">
						<#if ms.image?exists && ms.image != ''>
		  					<img class="fl" src="${ms.image!''}" name="img" id="imghref"   style="width:100px;height:100px;border:1px solid #f1f1f1;">
		  					<#else>
		  					<img class="fl" src="/mall/themes/b2b2cv2/images/default_goods_image_tiny.gif" name="img" id="imghref"   style="width:100px;height:100px;border:1px solid #f1f1f1;">
	  					</#if>
						<span class=" ncu_btn7" style="display: block; cursor:pointer;">上传图片</span>
						<input class="fl cb mt10 file" type="file"  name="file" onchange="preview2(this)"/>
						<span class="fl cb tal" style="">建议上传图片大小为100x100,支持格式jpg,png,gif，<br>请保证图片清晰且文件大小不超过400KB</span>
					</dt>
				</dl>
                <dl>
                    <dt class="required">文字内容:</dt>
                    <dd id="text_1" class="pr">
                        <textarea name="" id="textarea" cols="30" rows="10" class="w404 h150"></textarea>
                    </dd>
                </dl>
                <dl>
                    <dt class="required">图片内容:</dt>
                    <dt class="apply_id_img pr w404">
                            <span class="cropped"></span>
                            <img class="fl" src="" name="img" id="img"  style="width:210px;height:110px">
                            <span class="ncu_btn7" style="display: block; cursor:pointer;">上传图片</span>
                            <input class="fl cb mt10 file" id="file" type="file" name="file" onchange="previewTest(this)"/>
                            <span class="fl">支持格式jpg,png,gif，请保证图片清晰且文件大小不超过400KB</span>
                    </dt>
                </dl> 
            </form>
            <div>
                <dl>
                    <dt></dt>
                    <dt class="w404">
                        <span class="ncu_btn6 cp" id="add_textarea">添加文字</span>
                        <span class="ncu_btn6 cp" id="add_img">添加图片</span>
                    </dt>
                </dl>
            </div>
            <div>
                <dl>
                    <dt></dt>
                    <dt class="w404 tc">
                        <span class="ncu_btn8 cp" id="add_submit"  onclick="refreshSubmit();">刷新</span>
                    <p>在APP中显示位置如右图</p>
                    </dt>
                </dl>
            </div>
        </div>
        <div class="store_right_main_list">
            <div class="store_right_main_list_head"><span class="fl"><</span>信息详情<i></i></div>
            <ul class="store_right_main_list_body">
              <li style="width: 228px;height: 30px;text-align: center; line-height:30px;"><b id="head_title">${ms.title}</b>
                </li>
                <li class="lowh"><p style="word-break:break-all; color: #666666;" id="lowhp">4.设置方法
                    rect(x,y,width,height) - 设置矩形形状
                    x和y - 设置矩形的左上角坐标值
                    width和height - 设置矩形的宽度和高度
                    arc(x,y,radius,startAngle,endAngle,direction) - 设置圆形形状
                    x和y - 设置圆形的圆心坐标值
                    radius - 设置圆形的半径
                    startAngle和endAngle - 设置圆形的起始位置
                    direction - 按照顺时针或逆时针绘制
                    5.绘制方法
                    stroke() - 绘制轮廓
                    fill() - 绘制填充rect(x,y,width,height) - 设置矩形形状
                    x和y - 设置矩形的左上角坐标值
                    width和height - 设置矩形的宽度和高度
                    arc(x,y,radius,startAngle,endAngle,direction) - 设置圆形形状
                    x和y - 设置圆形的圆心坐标值
                    radius - 设置圆形的半径
                    startAngle和endAngle - 设置圆形的起始位置
                    direction - 按照顺时针或逆时针绘制
                    5.绘制方法
                    stroke() - 绘制轮廓
                    fill() - 绘制填充
                </p></li> 
            </ul>
            <ul class="store_right_main_list_bottom"></ul>
        </div>
    </div>
</div>
	<script>
		<!--显示是否有链接的,如果没有链接的display_link的class的样式增加none否则没有none样式-->
		$("#yes_link").click(function(){
			$(".display_link").css("display","block");
		});
		$("#no_link").click(function(){
			$(".display_link").css("display","none");
			$("#linkGoods_id").val("");
			$("#synopsis").val("");
		});
	</script>
	<script>
		function preview2(file) {
			if (file.files && file.files[0]) {
				var reader = new FileReader();
				reader.onload = function (evt) {
					$("#imghref").attr("src", evt.target.result);
				};
				reader.readAsDataURL(file.files[0]);
			}
		}
	</script>
	<script type="text/javascript">
			var dialog;
			
			function open_server_iframe(linkGoods_id) {
			    var map = {}; // 相当于Map map = new HashMap();
			    map["title"] = "出售中的商品列表";
			    map["html"] = "${ctx}/goods/server_goods_insert_list.html?linkGoodsId="+linkGoods_id;
			    map["form"] = "#adv-form";
			    openDialog(map);
			}
			
			function openDialog(map) {
			    dialog = $.dialog({
			        title : map["title"],
			        lock : true,
			        min : false,
			        max : false,
			        width:960
			    });
			
			    $.ajax({
			        url : map["html"],
			        cache : false,
			        success : function(html) {
			            dialog.content(html);
			            dialog.button([ {
			                name : '保存',
			                callback : function() {
			                	 var goodsIdAndName=$('input:radio[name="goods_id"]:checked').val();
			                     if(goodsIdAndName==null){
			                         alert("请选择一件商品!");
			                         return false;
			                     }
			                    formSubmit(dialog,goodsIdAndName);
			                    this.button({
			                                name: '保存',
			                                disabled: true
			                            })
			                            .lock();
			                }
			            }, {
			                name : '取消'
			            } ]);
			        },
			        error : function() {
			            $.alert("出现错误,请重试！");
			        }
			    });
			}
		 function formSubmit(dialog,goodsIdAndName) {
		    	var goods = goodsIdAndName.split(",");//以逗号作为分隔字符串
		    	$("#linkGoods_id").val($.trim(goods[0]));
		        $("#synopsis").val($.trim(goods[1]));
		    }
	</script>
	<script>
		var num = 0;
        $(document).ready(function () {
        	var detail = '${ms.detail}';
        	var reg=new RegExp("<br>","g");
        	var str= detail.replace(reg,"\n");
        	$("#lowhp").html(str);
        	var length = $("#lowhp").children().length;
       		$("#lowhp").children().each(function(index,element){
       			if(index == 0){
	           		$("#textarea").val($(this).text().replace(reg,"\n"));
       			}else if(index == 1){
	           		$("#img").attr("src",element.src);
       			}else if(index <= length){
       				for(var i=1;i<=length-2;i++){
       					num = length-2;
       	    			 if($(this).attr("id") == "textarea"+i){
   	    				   $("#add_form").append('<dl>'+
				           						 '<dt class="required">文字内容:</dt>'+
				           						 '<dd  class="pr">'+
					           						 '<i class="clear_img pa" id="clear_textarea'+i+'" name="'+i+'"></i>'+
					           						 '<textarea name="" id="textarea'+i+'"  cols="30" rows="10" class="w404 h150" ></textarea>'+
				           						 '</dd>'+
				           						 '</dl>')
				           	$("#textarea"+i).val($(this).text().replace(reg,"\n"));
   	    				 	$("#clear_textarea"+i).click(function(){
		   	   	            	var nowNum = $(this).attr("name");
		   	   	            	for(var i= Number(nowNum)+1;i<=num;i++){
		   	   	            		$("#textarea"+i).attr("id","textarea"+(i-1));
		   	   	            		$("#clear_textarea"+i).attr("name",(i-1));
		   	   	            		$("#clear_textarea"+i).attr("id","clear_textarea"+(i-1));
		   	   	            		
		   	   	            		$("#img"+i).attr("id","img"+(i-1));
		   	   	            		$("#clear_img"+i).attr("name",(i-1));
		   	   	            		$("#clear_img"+i).attr("id","clear_img"+(i-1));
		   	   	            	}
		   	   	            	num = num-1;
		   	   	            	if(num  < 0){
		   	   	            		num = 0;
		   	   	            	} 
		   	   	                $(this).parent().parent().remove();
	   	   	            	});
       	    			}else if($(this).attr("id") == "img"+i){
	       	    			$("#add_form").append('<dl>'+
					           					  '<dt class="required">图片内容:</dt>'+
					           					  '<dt class="apply_id_img pr w404">'+
					           					  '<i class="clear_img pa" id="clear_img'+i+'" name="'+i+'"></i>'+
					           					  '<span class="cropped"></span>'+
					           					  '<img class="fl" src="'+element.src+'" name="img" id="img'+i+'"  style="width:210px;height:110px">'+
					           					  '<a href="javascript:(0)" class=" upload-file ncu_btn7" style="display:block;">上传图片</a>'+
					           					  '<input class="fl cb mt10 file" id="file'+i+'" type="file" name="file" onchange="preview(this,'+i+')"/>'+
					           					  '<span class="fl">支持格式jpg,png,gif，请保证图片清晰且文件大小不超过400KB</span>'+
					           					  '</dt>'+
					       					  '</dl>');
	       	    		//给新增的图片框增加删除事件
	       	                $("#clear_img"+i).click(function(){
	       	                	var nowNum = $(this).attr("name");
	       	                	for(var i= Number(nowNum)+1;i<=num;i++){
	       	                		$("#textarea"+i).attr("id","textarea"+(i-1));
	       	                		$("#clear_textarea"+i).attr("name",(i-1));
	       	                		$("#clear_textarea"+i).attr("id","clear_textarea"+(i-1));
	       	                		
	       	                		$("#img"+i).attr("id","img"+(i-1));
	       	                		$("#clear_img"+i).attr("name",(i-1));
	       	                		$("#clear_img"+i).attr("id","clear_img"+(i-1));
	       	                	}
	       	                	num = num-1;
	       	                	if(num  < 0){
	       	                		num = 0;
	       	                	} 
	       	                	var filePath = $("#img"+nowNum).attr("src");
	       	                	if(filePath != ""){
	       	                		deleteFile(filePath);
	       	                	}
	       	                    $(this).parent().parent().remove();
	       	                });
       	    			} 
       	    		}
       			}
           	});
       		refreshSubmit();
		//增加文字输入框。
            $("#add_textarea").click(function(){
	        	num = num+1;
	            $("#add_form").append('<dl>'+
	           						 '<dt class="required">文字内容:</dt>'+
	           						 '<dd  class="pr">'+
		           						 '<i class="clear_img pa" id="clear_textarea'+num+'" name="'+num+'"></i>'+
		           						 '<textarea name="" id="textarea'+num+'" cols="30" rows="10" class="w404 h150" ></textarea>'+
	           						 '</dd>'+
	           						 '</dl>')
		//给新增的文本框增加删除事件
	            $("#clear_textarea"+num).click(function(){
	            	var nowNum = $(this).attr("name");
	            	for(var i= Number(nowNum)+1;i<=num;i++){
	            		$("#textarea"+i).attr("id","textarea"+(i-1));
	            		$("#clear_textarea"+i).attr("name",(i-1));
	            		$("#clear_textarea"+i).attr("id","clear_textarea"+(i-1));
	            		
	            		$("#img"+i).attr("id","img"+(i-1));
	            		$("#clear_img"+i).attr("name",(i-1));
	            		$("#clear_img"+i).attr("id","clear_img"+(i-1));
	            	}
	            	num = num-1;
	            	if(num  < 0){
	            		num = 0;
	            	} 
	                $(this).parent().parent().remove();
	            });
       		});
		//增加图片事件。
            $("#add_img").click(function(){
            	num = num+1;
                $("#add_form").append('<dl>'+
    	            					  '<dt class="required">图片内容:</dt>'+
    	            					  '<dt class="apply_id_img pr w404">'+
    	            					  '<i class="clear_img pa" id="clear_img'+num+'" name="'+num+'"></i>'+
    	            					  '<span class="cropped"></span>'+
    	            					  '<img class="fl" src="" name="img" id="img'+num+'"  style="width:210px;height:110px">'+
    	            					  '<a href="javascript:(0)" class=" upload-file ncu_btn7" style="display:block;">上传图片</a>'+
    	            					  '<input class="fl cb mt10 file" id="file'+num+'" type="file" name="file" onchange="preview(this,'+num+')"/>'+
    	            					  '<span class="fl">支持格式jpg,png,gif，请保证图片清晰且文件大小不超过400KB</span>'+
    	            					  '</dt>'+
                					  '</dl>');
		//给新增的图片框增加删除事件
                $("#clear_img"+num).click(function(){
                	var nowNum = $(this).attr("name");
                	for(var i= Number(nowNum)+1;i<=num;i++){
                		$("#textarea"+i).attr("id","textarea"+(i-1));
                		$("#clear_textarea"+i).attr("name",(i-1));
                		$("#clear_textarea"+i).attr("id","clear_textarea"+(i-1));
                		
                		$("#img"+i).attr("id","img"+(i-1));
                		$("#clear_img"+i).attr("name",(i-1));
                		$("#clear_img"+i).attr("id","clear_img"+(i-1));
                	}
                	num = num-1;
                	if(num  < 0){
                		num = 0;
                	} 
                	var filePath = $("#img"+nowNum).attr("src");
                	if(filePath != ""){
                		deleteFile(filePath);
                	}
                    $(this).parent().parent().remove();
                });
            });
			//文件删除
            function deleteFile(filePath){
    			$.ajax({
    	          	url : "${ctx}/api/shop/appMessageAction!deleteFile.do",
    	          	type : "POST",
    	          	data : {filePath:filePath},
    	            dataType: 'json', //返回值类型 一般设置为json
    	          	success: function(data,status){
    	          		//console.log(data);
    	          	},
    	          	error: function(data, status, e){
    	          		//alert(e);
    	          	}
    	          });
    		}
		
            $("#submit_btn").click(function () {
            	
            	refreshSubmit();
                var title = $("#title").val();
                //var synopsis = $("#synopsis").val();
                var author = $("#author").val();
                var file = $("#imghref")[0].src;
                var detail = $("#detail").val(aa);
                if (title == "" || author == "" || file == "") {
                    alert("请填写完整的商品信息");
                    return false;
                } else {
                	 var options = {
                             url: "${ctx}/api/shop/appMessageAction!edit.do",
                             type: "POST",
                             dataType: "json",
                             success: function (data) {
                                 if (data.result == 1) {
                                     alert(data.message);
                                     location.href="${ctx}/store/server/server_list.html?menu=promotion";
                                 } else {
                                     alert("系统异常:" + data.message);
                                 }
                             },
                             error: function (XMLHttpRequest, textStatus, errorThrown) {
                                 alert("系统异常，请稍候重试！");
                             }
                         }
                      $("#add_form").ajaxSubmit(options);
                }
            });
            $("#return_1").click(function () {
                window.history.back(-1);
            });
        });
        //文件上传事件
        function previewTest(file){
        	 if (file.files && file.files[0]) {
                 var reader = new FileReader();
                 reader.onload = function (evt) {
   	                //$('#img').attr("src", evt.target.result);
   	            	$.ajaxFileUpload({
   	                  	url : "${ctx}/api/shop/appMessageAction!fileUploadImg.do",
   	                  	secureuri: false, //是否需要安全协议，一般设置为false
   	                    fileElementId: 'file', //文件上传域的ID
   	                    dataType: 'json', //返回值类型 一般设置为json
   	                  	success: function(data,status){
   	                  		 $('#img').attr("src", data.url);
   	                  	},
   	                  	error: function(data, status, e){
   	                  		alert(e);
   	                  	}
   	                  });
                 };
                 reader.readAsDataURL(file.files[0]);
             }
        }
        function preview(file,mun) {
        	 if (file.files && file.files[0]) {
                 var reader = new FileReader();
                 reader.onload = function (evt) {
                     if(num > 0){
                     	//$('#img'+num).attr("src", evt.target.result);
                     		$.ajaxFileUpload({
                               	url : "${ctx}/api/shop/appMessageAction!fileUploadImg.do",
                               	secureuri: false, //是否需要安全协议，一般设置为false
                                fileElementId: 'file'+mun, //文件上传域的ID
                                dataType: 'json', //返回值类型 一般设置为json
                               	success: function(data,status){
                               		 $('#img'+mun).attr("src", data.url);
                               	},
                               	error: function(data, status, e){
                               		alert(e);
                               	}
                               });
                     	}
                 };
                 reader.readAsDataURL(file.files[0]);
             }
        }
        //刷新事件
        var aa;
        function refreshSubmit(){
        	$("#head_title").text(function () {
                var title = $("#title").val();
                return title;
            });
        	var reg=new RegExp("\n","g");
        	if(typeof($("#textarea").val()) != "undefined"){
        		var str= $("#textarea").val().replace(reg,"<br>");
    	   		aa = '<p id="textarea">'+str+'</p>';
        	}
       		aa += '<img class="srmlb_1" id="img" src="'+ $('#img').attr("src")+'" alt="" style="width: 100%;height: 100%;vertical-align: middle;" onclick="goodsIdHref();"></img>';
        	if(num > 0){
        		for(var i=1;i<=num;i++){
        			if(typeof($("#textarea"+i).val()) != "undefined"){
        				if($("#textarea"+i).val() != "" ){
        					var str= $("#textarea"+i).val().replace(reg,"<br>");
        					aa += '<p id="textarea'+i+'">'+str+'</p>';
            			}
        			}else{
        				if(typeof($('#img'+i).attr("src")) != "undefined"){
        					 if($('#img'+i).attr("src") != ""){
        				    		aa += '<img class="srmlb_1" id="img'+i+'" src="'+ $('#img'+i).attr("src")+'" alt="" style="width: 100%;height: 100%;vertical-align: middle;" onclick="goodsIdHref();"></img>';
        		    		}
        				}
        			}
        		}
        	} 
        	$("#lowhp").html(aa);
        	$("#detail").val(aa);
        }
</script>
<#include '/common/footer.html' />